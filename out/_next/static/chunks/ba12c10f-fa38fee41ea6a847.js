"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[989],{4913:function(e,t,a){a.d(t,{Pu:function(){return ee}});var s,r=a(2219),o=a(1682),i=a(3437);a(3753);var l=Object.defineProperty,n=(Symbol.for("vercel.ai.error.AI_NoOutputSpecifiedError"),Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),Symbol.for("vercel.ai.error.AI_InvalidStreamPartError"),Symbol.for("vercel.ai.error.AI_InvalidToolInputError"),Symbol.for("vercel.ai.error.AI_MCPClientError"),Symbol.for("vercel.ai.error.AI_NoImageGeneratedError"),"AI_NoObjectGeneratedError"),p=`vercel.ai.error.${n}`,d=Symbol.for(p),u=class extends o.AX{constructor({message:e="No object generated.",cause:t,text:a,response:r,usage:o,finishReason:i}){super({name:n,message:e,cause:t}),this[s]=!0,this.text=a,this.response=r,this.usage=o,this.finishReason=i}static isInstance(e){return o.AX.hasMarker(e,p)}};s=d,Symbol.for("vercel.ai.error.AI_NoOutputGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchToolError"),Symbol.for("vercel.ai.error.AI_ToolCallRepairError"),Symbol.for("vercel.ai.error.AI_InvalidDataContentError"),Symbol.for("vercel.ai.error.AI_InvalidMessageRoleError"),Symbol.for("vercel.ai.error.AI_MessageConversionError"),Symbol.for("vercel.ai.error.AI_DownloadError"),Symbol.for("vercel.ai.error.AI_RetryError");var c=i.G0([i.Z_(),i.Pp(Uint8Array),i.Pp(ArrayBuffer),i.PG(e=>{var t,a;return null!=(a=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&a},{message:"Must be a Buffer"})]),m=i.Vo(()=>i.G0([i.lB(),i.Z_(),i.Rx(),i.O7(),i.IM(i.Z_(),m),i.IX(m)])),h=i.IM(i.Z_(),i.IM(i.Z_(),m)),y=i.Ry({type:i.i0("text"),text:i.Z_(),providerOptions:h.optional()}),_=i.Ry({type:i.i0("image"),image:i.G0([c,i.Pp(URL)]),mediaType:i.Z_().optional(),providerOptions:h.optional()}),v=i.Ry({type:i.i0("file"),data:i.G0([c,i.Pp(URL)]),filename:i.Z_().optional(),mediaType:i.Z_(),providerOptions:h.optional()}),I=i.Ry({type:i.i0("reasoning"),text:i.Z_(),providerOptions:h.optional()}),g=i.Ry({type:i.i0("tool-call"),toolCallId:i.Z_(),toolName:i.Z_(),input:i._4(),providerOptions:h.optional(),providerExecuted:i.O7().optional()}),E=i.VK("type",[i.Ry({type:i.i0("text"),value:i.Z_()}),i.Ry({type:i.i0("json"),value:m}),i.Ry({type:i.i0("error-text"),value:i.Z_()}),i.Ry({type:i.i0("error-json"),value:m}),i.Ry({type:i.i0("content"),value:i.IX(i.G0([i.Ry({type:i.i0("text"),text:i.Z_()}),i.Ry({type:i.i0("media"),data:i.Z_(),mediaType:i.Z_()})]))})]),f=i.Ry({type:i.i0("tool-result"),toolCallId:i.Z_(),toolName:i.Z_(),output:E,providerOptions:h.optional()}),R=i.Ry({role:i.i0("system"),content:i.Z_(),providerOptions:h.optional()}),b=i.Ry({role:i.i0("user"),content:i.G0([i.Z_(),i.IX(i.G0([y,_,v]))]),providerOptions:h.optional()}),T=i.Ry({role:i.i0("assistant"),content:i.G0([i.Z_(),i.IX(i.G0([y,v,I,g,f]))]),providerOptions:h.optional()}),x=i.Ry({role:i.i0("tool"),content:i.IX(f),providerOptions:h.optional()});i.G0([R,b,T,x]),(0,r.bF)({prefix:"aitxt",size:24});var A=i.G0([i.cf({type:i.i0("text-start"),id:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.i0("text-delta"),id:i.Z_(),delta:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.i0("text-end"),id:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.i0("error"),errorText:i.Z_()}),i.cf({type:i.i0("tool-input-start"),toolCallId:i.Z_(),toolName:i.Z_(),providerExecuted:i.O7().optional(),dynamic:i.O7().optional()}),i.cf({type:i.i0("tool-input-delta"),toolCallId:i.Z_(),inputTextDelta:i.Z_()}),i.cf({type:i.i0("tool-input-available"),toolCallId:i.Z_(),toolName:i.Z_(),input:i._4(),providerExecuted:i.O7().optional(),providerMetadata:h.optional(),dynamic:i.O7().optional()}),i.cf({type:i.i0("tool-input-error"),toolCallId:i.Z_(),toolName:i.Z_(),input:i._4(),providerExecuted:i.O7().optional(),providerMetadata:h.optional(),dynamic:i.O7().optional(),errorText:i.Z_()}),i.cf({type:i.i0("tool-output-available"),toolCallId:i.Z_(),output:i._4(),providerExecuted:i.O7().optional(),dynamic:i.O7().optional(),preliminary:i.O7().optional()}),i.cf({type:i.i0("tool-output-error"),toolCallId:i.Z_(),errorText:i.Z_(),providerExecuted:i.O7().optional(),dynamic:i.O7().optional()}),i.cf({type:i.i0("reasoning"),text:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.i0("reasoning-start"),id:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.i0("reasoning-delta"),id:i.Z_(),delta:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.i0("reasoning-end"),id:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.i0("reasoning-part-finish")}),i.cf({type:i.i0("source-url"),sourceId:i.Z_(),url:i.Z_(),title:i.Z_().optional(),providerMetadata:h.optional()}),i.cf({type:i.i0("source-document"),sourceId:i.Z_(),mediaType:i.Z_(),title:i.Z_(),filename:i.Z_().optional(),providerMetadata:h.optional()}),i.cf({type:i.i0("file"),url:i.Z_(),mediaType:i.Z_(),providerMetadata:h.optional()}),i.cf({type:i.Z_().startsWith("data-"),id:i.Z_().optional(),data:i._4(),transient:i.O7().optional()}),i.cf({type:i.i0("start-step")}),i.cf({type:i.i0("finish-step")}),i.cf({type:i.i0("start"),messageId:i.Z_().optional(),messageMetadata:i._4().optional()}),i.cf({type:i.i0("finish"),messageMetadata:i._4().optional()}),i.cf({type:i.i0("abort")}),i.cf({type:i.i0("message-metadata"),messageMetadata:i._4()})]);async function M(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=await (0,r.NX)({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=await (0,r.NX)({text:function(e){let t=["ROOT"],a=-1,s=null;function r(e,r,o){switch(e){case'"':a=r,t.pop(),t.push(o),t.push("INSIDE_STRING");break;case"f":case"t":case"n":a=r,s=r,t.pop(),t.push(o),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(o),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":a=r,t.pop(),t.push(o),t.push("INSIDE_NUMBER");break;case"{":a=r,t.pop(),t.push(o),t.push("INSIDE_OBJECT_START");break;case"[":a=r,t.pop(),t.push(o),t.push("INSIDE_ARRAY_START")}}function o(e,s){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":a=s,t.pop()}}function i(e,s){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":a=s,t.pop()}}for(let l=0;l<e.length;l++){let n=e[l];switch(t[t.length-1]){case"ROOT":r(n,l,"FINISH");break;case"INSIDE_OBJECT_START":switch(n){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":a=l,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===n&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===n&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===n&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":r(n,l,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":o(n,l);break;case"INSIDE_STRING":switch(n){case'"':t.pop(),a=l;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:a=l}break;case"INSIDE_ARRAY_START":"]"===n?(a=l,t.pop()):(a=l,r(n,l,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(n){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":a=l,t.pop();break;default:a=l}break;case"INSIDE_ARRAY_AFTER_COMMA":r(n,l,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),a=l;break;case"INSIDE_NUMBER":switch(n){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":a=l;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(n,l),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&o(n,l);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&o(n,l);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(n,l);break;default:t.pop()}break;case"INSIDE_LITERAL":{let r=e.substring(s,l+1);"false".startsWith(r)||"true".startsWith(r)||"null".startsWith(r)?a=l:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?o(n,l):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(n,l))}}}let l=e.slice(0,a+1);for(let a=t.length-1;a>=0;a--)switch(t[a]){case"INSIDE_STRING":l+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":l+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":l+="]";break;case"INSIDE_LITERAL":{let t=e.substring(s,e.length);"true".startsWith(t)?l+="true".slice(t.length):"false".startsWith(t)?l+="false".slice(t.length):"null".startsWith(t)&&(l+="null".slice(t.length))}}return l}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}function C(e){return e.type.startsWith("tool-")}function S(e){return C(e)||"dynamic-tool"===e.type}function N(e){return e.type.split("-").slice(1).join("-")}async function Z({stream:e,onError:t}){let a=e.getReader();try{for(;;){let{done:e}=await a.read();if(e)break}}catch(e){null==t||t(e)}finally{a.releaseLock()}}(0,r.bF)({prefix:"aitxt",size:24}),(0,r.bF)({prefix:"aiobj",size:24});var w=class{constructor(){this.queue=[],this.isProcessing=!1}async processQueue(){if(!this.isProcessing){for(this.isProcessing=!0;this.queue.length>0;)await this.queue[0](),this.queue.shift();this.isProcessing=!1}}async run(e){return new Promise((t,a)=>{this.queue.push(async()=>{try{await e(),t()}catch(e){a(e)}}),this.processQueue()})}};(0,r.bF)({prefix:"aiobj",size:24}),((e,t)=>{for(var a in t)l(e,a,{get:t[a],enumerable:!0})})({},{object:()=>k,text:()=>O});var O=()=>({type:"text",responseFormat:{type:"text"},parsePartial:async({text:e})=>({partial:e}),parseOutput:async({text:e})=>e}),k=({schema:e})=>{let t=(0,r.C3)(e);return{type:"object",responseFormat:{type:"json",schema:t.jsonSchema},async parsePartial({text:e}){let t=await M(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},async parseOutput({text:e},a){let s=await (0,r.NX)({text:e});if(!s.success)throw new u({message:"No object generated: could not parse the response.",cause:s.error,text:e,response:a.response,usage:a.usage,finishReason:a.finishReason});let o=await (0,r.pW)({value:s.value,schema:t});if(!o.success)throw new u({message:"No object generated: response did not match schema.",cause:o.error,text:e,response:a.response,usage:a.usage,finishReason:a.finishReason});return o.value}}},D=(Symbol.for("vercel.ai.error.AI_NoSuchProviderError"),i.d7({name:i.Z_(),version:i.Z_()})),F=i.d7({_meta:i.jt(i.Ry({}).loose())}),P=i.Ry({method:i.Z_(),params:i.jt(F)}),j=i.d7({experimental:i.jt(i.Ry({}).loose()),logging:i.jt(i.Ry({}).loose()),prompts:i.jt(i.d7({listChanged:i.jt(i.O7())})),resources:i.jt(i.d7({subscribe:i.jt(i.O7()),listChanged:i.jt(i.O7())})),tools:i.jt(i.d7({listChanged:i.jt(i.O7())}))});F.extend({protocolVersion:i.Z_(),capabilities:j,serverInfo:D,instructions:i.jt(i.Z_())});var B=F.extend({nextCursor:i.jt(i.Z_())}),L=i.Ry({name:i.Z_(),description:i.jt(i.Z_()),inputSchema:i.Ry({type:i.i0("object"),properties:i.jt(i.Ry({}).loose())}).loose()}).loose();B.extend({tools:i.IX(L)});var G=i.Ry({type:i.i0("text"),text:i.Z_()}).loose(),U=i.Ry({type:i.i0("image"),data:i.US(),mimeType:i.Z_()}).loose(),J=i.Ry({uri:i.Z_(),mimeType:i.jt(i.Z_())}).loose(),Y=J.extend({text:i.Z_()}),q=J.extend({blob:i.US()}),V=i.Ry({type:i.i0("resource"),resource:i.G0([Y,q])}).loose();F.extend({content:i.IX(i.G0([G,U,V])),isError:i.O7().default(!1).optional()}).or(F.extend({toolResult:i._4()}));var W=i.Ry({jsonrpc:i.i0("2.0"),id:i.G0([i.Z_(),i.Rx().int()])}).merge(P).strict(),X=i.Ry({jsonrpc:i.i0("2.0"),id:i.G0([i.Z_(),i.Rx().int()]),result:F}).strict(),K=i.Ry({jsonrpc:i.i0("2.0"),id:i.G0([i.Z_(),i.Rx().int()]),error:i.Ry({code:i.Rx().int(),message:i.Z_(),data:i.jt(i._4())})}).strict(),$=i.Ry({jsonrpc:i.i0("2.0")}).merge(i.Ry({method:i.Z_(),params:i.jt(F)})).strict();async function z(e){if(null==e)return[];if(!globalThis.FileList||!(e instanceof globalThis.FileList))throw Error("FileList is not supported in the current environment");return Promise.all(Array.from(e).map(async e=>{let{name:t,type:a}=e;return{type:"file",mediaType:a,filename:t,url:await new Promise((t,a)=>{let s=new FileReader;s.onload=e=>{var a;t(null==(a=e.target)?void 0:a.result)},s.onerror=e=>a(e),s.readAsDataURL(e)})}}))}i.G0([W,$,X,K]);var Q=class{constructor({api:e="/api/chat",credentials:t,headers:a,body:s,fetch:r,prepareSendMessagesRequest:o,prepareReconnectToStreamRequest:i}){this.api=e,this.credentials=t,this.headers=a,this.body=s,this.fetch=r,this.prepareSendMessagesRequest=o,this.prepareReconnectToStreamRequest=i}async sendMessages({abortSignal:e,...t}){var a,s,o,i,l;let n=await (0,r.DB)(this.body),p=await (0,r.DB)(this.headers),d=await (0,r.DB)(this.credentials),u=await (null==(a=this.prepareSendMessagesRequest)?void 0:a.call(this,{api:this.api,id:t.chatId,messages:t.messages,body:{...n,...t.body},headers:{...p,...t.headers},credentials:d,requestMetadata:t.metadata,trigger:t.trigger,messageId:t.messageId})),c=null!=(s=null==u?void 0:u.api)?s:this.api,m=(null==u?void 0:u.headers)!==void 0?u.headers:{...p,...t.headers},h=(null==u?void 0:u.body)!==void 0?u.body:{...n,...t.body,id:t.chatId,messages:t.messages,trigger:t.trigger,messageId:t.messageId},y=null!=(o=null==u?void 0:u.credentials)?o:d,_=null!=(i=this.fetch)?i:globalThis.fetch,v=await _(c,{method:"POST",headers:{"Content-Type":"application/json",...m},body:JSON.stringify(h),credentials:y,signal:e});if(!v.ok)throw Error(null!=(l=await v.text())?l:"Failed to fetch the chat response.");if(!v.body)throw Error("The response body is empty.");return this.processResponseStream(v.body)}async reconnectToStream(e){var t,a,s,o,i;let l=await (0,r.DB)(this.body),n=await (0,r.DB)(this.headers),p=await (0,r.DB)(this.credentials),d=await (null==(t=this.prepareReconnectToStreamRequest)?void 0:t.call(this,{api:this.api,id:e.chatId,body:{...l,...e.body},headers:{...n,...e.headers},credentials:p,requestMetadata:e.metadata})),u=null!=(a=null==d?void 0:d.api)?a:`${this.api}/${e.chatId}/stream`,c=(null==d?void 0:d.headers)!==void 0?d.headers:{...n,...e.headers},m=null!=(s=null==d?void 0:d.credentials)?s:p,h=null!=(o=this.fetch)?o:globalThis.fetch,y=await h(u,{method:"GET",headers:c,credentials:m});if(204===y.status)return null;if(!y.ok)throw Error(null!=(i=await y.text())?i:"Failed to fetch the chat response.");if(!y.body)throw Error("The response body is empty.");return this.processResponseStream(y.body)}},H=class extends Q{constructor(e={}){super(e)}processResponseStream(e){return(0,r.RF)({stream:e,schema:A}).pipeThrough(new TransformStream({async transform(e,t){if(!e.success)throw e.error;t.enqueue(e.value)}}))}},ee=class{constructor({generateId:e=r.Ox,id:t=e(),transport:a=new H,messageMetadataSchema:s,dataPartSchemas:o,state:i,onError:l,onToolCall:n,onFinish:p,onData:d,sendAutomaticallyWhen:u}){this.activeResponse=void 0,this.jobExecutor=new w,this.sendMessage=async(e,t)=>{var a,s,r,o;let i;if(null==e){await this.makeRequest({trigger:"submit-message",messageId:null==(a=this.lastMessage)?void 0:a.id,...t});return}if(i="text"in e||"files"in e?{parts:[...Array.isArray(e.files)?e.files:await z(e.files),..."text"in e&&null!=e.text?[{type:"text",text:e.text}]:[]]}:e,null!=e.messageId){let t=this.state.messages.findIndex(t=>t.id===e.messageId);if(-1===t)throw Error(`message with id ${e.messageId} not found`);if("user"!==this.state.messages[t].role)throw Error(`message with id ${e.messageId} is not a user message`);this.state.messages=this.state.messages.slice(0,t+1),this.state.replaceMessage(t,{...i,id:e.messageId,role:null!=(s=i.role)?s:"user",metadata:e.metadata})}else this.state.pushMessage({...i,id:null!=(r=i.id)?r:this.generateId(),role:null!=(o=i.role)?o:"user",metadata:e.metadata});await this.makeRequest({trigger:"submit-message",messageId:e.messageId,...t})},this.regenerate=async({messageId:e,...t}={})=>{let a=null==e?this.state.messages.length-1:this.state.messages.findIndex(t=>t.id===e);if(-1===a)throw Error(`message ${e} not found`);this.state.messages=this.state.messages.slice(0,"assistant"===this.messages[a].role?a:a+1),await this.makeRequest({trigger:"regenerate-message",messageId:e,...t})},this.resumeStream=async(e={})=>{await this.makeRequest({trigger:"resume-stream",...e})},this.clearError=()=>{"error"===this.status&&(this.state.error=void 0,this.setStatus({status:"ready"}))},this.addToolResult=async({tool:e,toolCallId:t,output:a})=>this.jobExecutor.run(async()=>{var e,s;let r=this.state.messages,o=r[r.length-1];this.state.replaceMessage(r.length-1,{...o,parts:o.parts.map(e=>S(e)&&e.toolCallId===t?{...e,state:"output-available",output:a}:e)}),this.activeResponse&&(this.activeResponse.state.message.parts=this.activeResponse.state.message.parts.map(e=>S(e)&&e.toolCallId===t?{...e,state:"output-available",output:a,errorText:void 0}:e)),"streaming"!==this.status&&"submitted"!==this.status&&(null==(e=this.sendAutomaticallyWhen)?void 0:e.call(this,{messages:this.state.messages}))&&this.makeRequest({trigger:"submit-message",messageId:null==(s=this.lastMessage)?void 0:s.id})}),this.stop=async()=>{var e;("streaming"===this.status||"submitted"===this.status)&&(null==(e=this.activeResponse)?void 0:e.abortController)&&this.activeResponse.abortController.abort()},this.id=t,this.transport=a,this.generateId=e,this.messageMetadataSchema=s,this.dataPartSchemas=o,this.state=i,this.onError=l,this.onToolCall=n,this.onFinish=p,this.onData=d,this.sendAutomaticallyWhen=u}get status(){return this.state.status}setStatus({status:e,error:t}){this.status!==e&&(this.state.status=e,this.state.error=t)}get error(){return this.state.error}get messages(){return this.state.messages}get lastMessage(){return this.state.messages[this.state.messages.length-1]}set messages(e){this.state.messages=e}async makeRequest({trigger:e,metadata:t,headers:a,body:s,messageId:o}){var i,l,n;this.setStatus({status:"submitted",error:void 0});let p=this.lastMessage,d=!1,u=!1,c=!1;try{let i;let l={state:function({lastMessage:e,messageId:t}){return{message:(null==e?void 0:e.role)==="assistant"?e:{id:t,metadata:void 0,role:"assistant",parts:[]},activeTextParts:{},activeReasoningParts:{},partialToolCalls:{}}}({lastMessage:this.state.snapshot(p),messageId:this.generateId()}),abortController:new AbortController};if(l.abortController.signal.addEventListener("abort",()=>{d=!0}),this.activeResponse=l,"resume-stream"===e){let e=await this.transport.reconnectToStream({chatId:this.id,metadata:t,headers:a,body:s});if(null==e){this.setStatus({status:"ready"});return}i=e}else i=await this.transport.sendMessages({chatId:this.id,messages:this.state.messages,abortSignal:l.abortController.signal,metadata:t,headers:a,body:s,trigger:e,messageId:o});await Z({stream:function({stream:e,messageMetadataSchema:t,dataPartSchemas:a,runUpdateMessageJob:s,onError:o,onToolCall:i,onData:l}){return e.pipeThrough(new TransformStream({async transform(e,n){await s(async({state:s,write:p})=>{var d,u,c,m;function h(e){let t=s.message.parts.filter(C).find(t=>t.toolCallId===e);if(null==t)throw Error("tool-output-error must be preceded by a tool-input-available");return t}function y(e){let t=s.message.parts.filter(e=>"dynamic-tool"===e.type).find(t=>t.toolCallId===e);if(null==t)throw Error("tool-output-error must be preceded by a tool-input-available");return t}function _(e){var t;let a=s.message.parts.find(t=>C(t)&&t.toolCallId===e.toolCallId);null!=a?(a.state=e.state,a.input=e.input,a.output=e.output,a.errorText=e.errorText,a.rawInput=e.rawInput,a.preliminary=e.preliminary,a.providerExecuted=null!=(t=e.providerExecuted)?t:a.providerExecuted,null!=e.providerMetadata&&"input-available"===a.state&&(a.callProviderMetadata=e.providerMetadata)):s.message.parts.push({type:`tool-${e.toolName}`,toolCallId:e.toolCallId,state:e.state,input:e.input,output:e.output,rawInput:e.rawInput,errorText:e.errorText,providerExecuted:e.providerExecuted,preliminary:e.preliminary,...null!=e.providerMetadata?{callProviderMetadata:e.providerMetadata}:{}})}function v(e){var t;let a=s.message.parts.find(t=>"dynamic-tool"===t.type&&t.toolCallId===e.toolCallId);null!=a?(a.state=e.state,a.toolName=e.toolName,a.input=e.input,a.output=e.output,a.errorText=e.errorText,a.rawInput=null!=(t=e.rawInput)?t:a.rawInput,a.preliminary=e.preliminary,null!=e.providerMetadata&&"input-available"===a.state&&(a.callProviderMetadata=e.providerMetadata)):s.message.parts.push({type:"dynamic-tool",toolName:e.toolName,toolCallId:e.toolCallId,state:e.state,input:e.input,output:e.output,errorText:e.errorText,preliminary:e.preliminary,...null!=e.providerMetadata?{callProviderMetadata:e.providerMetadata}:{}})}async function I(e){if(null!=e){let a=null!=s.message.metadata?function e(t,a){if(void 0===t&&void 0===a)return;if(void 0===t)return a;if(void 0===a)return t;let s={...t};for(let r in a)if(Object.prototype.hasOwnProperty.call(a,r)){let o=a[r];if(void 0===o)continue;let i=r in t?t[r]:void 0,l=null!==o&&"object"==typeof o&&!Array.isArray(o)&&!(o instanceof Date)&&!(o instanceof RegExp),n=null!=i&&"object"==typeof i&&!Array.isArray(i)&&!(i instanceof Date)&&!(i instanceof RegExp);l&&n?s[r]=e(i,o):s[r]=o}return s}(s.message.metadata,e):e;null!=t&&await (0,r.rJ)({value:a,schema:t}),s.message.metadata=a}}switch(e.type){case"text-start":{let t={type:"text",text:"",providerMetadata:e.providerMetadata,state:"streaming"};s.activeTextParts[e.id]=t,s.message.parts.push(t),p();break}case"text-delta":{let t=s.activeTextParts[e.id];t.text+=e.delta,t.providerMetadata=null!=(d=e.providerMetadata)?d:t.providerMetadata,p();break}case"text-end":{let t=s.activeTextParts[e.id];t.state="done",t.providerMetadata=null!=(u=e.providerMetadata)?u:t.providerMetadata,delete s.activeTextParts[e.id],p();break}case"reasoning-start":{let t={type:"reasoning",text:"",providerMetadata:e.providerMetadata,state:"streaming"};s.activeReasoningParts[e.id]=t,s.message.parts.push(t),p();break}case"reasoning-delta":{let t=s.activeReasoningParts[e.id];t.text+=e.delta,t.providerMetadata=null!=(c=e.providerMetadata)?c:t.providerMetadata,p();break}case"reasoning-end":{let t=s.activeReasoningParts[e.id];t.providerMetadata=null!=(m=e.providerMetadata)?m:t.providerMetadata,t.state="done",delete s.activeReasoningParts[e.id],p();break}case"file":s.message.parts.push({type:"file",mediaType:e.mediaType,url:e.url}),p();break;case"source-url":s.message.parts.push({type:"source-url",sourceId:e.sourceId,url:e.url,title:e.title,providerMetadata:e.providerMetadata}),p();break;case"source-document":s.message.parts.push({type:"source-document",sourceId:e.sourceId,mediaType:e.mediaType,title:e.title,filename:e.filename,providerMetadata:e.providerMetadata}),p();break;case"tool-input-start":{let t=s.message.parts.filter(C);s.partialToolCalls[e.toolCallId]={text:"",toolName:e.toolName,index:t.length,dynamic:e.dynamic},e.dynamic?v({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-streaming",input:void 0}):_({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-streaming",input:void 0,providerExecuted:e.providerExecuted}),p();break}case"tool-input-delta":{let t=s.partialToolCalls[e.toolCallId];t.text+=e.inputTextDelta;let{value:a}=await M(t.text);t.dynamic?v({toolCallId:e.toolCallId,toolName:t.toolName,state:"input-streaming",input:a}):_({toolCallId:e.toolCallId,toolName:t.toolName,state:"input-streaming",input:a}),p();break}case"tool-input-available":e.dynamic?v({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-available",input:e.input,providerMetadata:e.providerMetadata}):_({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-available",input:e.input,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}),p(),i&&!e.providerExecuted&&await i({toolCall:e});break;case"tool-input-error":e.dynamic?v({toolCallId:e.toolCallId,toolName:e.toolName,state:"output-error",input:e.input,errorText:e.errorText,providerMetadata:e.providerMetadata}):_({toolCallId:e.toolCallId,toolName:e.toolName,state:"output-error",input:void 0,rawInput:e.input,errorText:e.errorText,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}),p();break;case"tool-output-available":if(e.dynamic){let t=y(e.toolCallId);v({toolCallId:e.toolCallId,toolName:t.toolName,state:"output-available",input:t.input,output:e.output,preliminary:e.preliminary})}else{let t=h(e.toolCallId);_({toolCallId:e.toolCallId,toolName:N(t),state:"output-available",input:t.input,output:e.output,providerExecuted:e.providerExecuted,preliminary:e.preliminary})}p();break;case"tool-output-error":if(e.dynamic){let t=y(e.toolCallId);v({toolCallId:e.toolCallId,toolName:t.toolName,state:"output-error",input:t.input,errorText:e.errorText})}else{let t=h(e.toolCallId);_({toolCallId:e.toolCallId,toolName:N(t),state:"output-error",input:t.input,rawInput:t.rawInput,errorText:e.errorText})}p();break;case"start-step":s.message.parts.push({type:"step-start"});break;case"finish-step":s.activeTextParts={},s.activeReasoningParts={};break;case"start":null!=e.messageId&&(s.message.id=e.messageId),await I(e.messageMetadata),(null!=e.messageId||null!=e.messageMetadata)&&p();break;case"finish":case"message-metadata":await I(e.messageMetadata),null!=e.messageMetadata&&p();break;case"error":null==o||o(Error(e.errorText));break;default:if(e.type.startsWith("data-")){if((null==a?void 0:a[e.type])!=null&&await (0,r.rJ)({value:e.data,schema:a[e.type]}),e.transient){null==l||l(e);break}let t=null!=e.id?s.message.parts.find(t=>e.type===t.type&&e.id===t.id):void 0;null!=t?t.data=e.data:s.message.parts.push(e),null==l||l(e),p()}}n.enqueue(e)})}}))}({stream:i,onToolCall:this.onToolCall,onData:this.onData,messageMetadataSchema:this.messageMetadataSchema,dataPartSchemas:this.dataPartSchemas,runUpdateMessageJob:e=>this.jobExecutor.run(()=>e({state:l.state,write:()=>{var e;this.setStatus({status:"streaming"}),l.state.message.id===(null==(e=this.lastMessage)?void 0:e.id)?this.state.replaceMessage(this.state.messages.length-1,l.state.message):this.state.pushMessage(l.state.message)}})),onError:e=>{throw e}}),onError:e=>{throw e}}),this.setStatus({status:"ready"})}catch(e){if(d||"AbortError"===e.name)return d=!0,this.setStatus({status:"ready"}),null;c=!0,e instanceof TypeError&&(e.message.toLowerCase().includes("fetch")||e.message.toLowerCase().includes("network"))&&(u=!0),this.onError&&e instanceof Error&&this.onError(e),this.setStatus({status:"error",error:e})}finally{try{null==(i=this.onFinish)||i.call(this,{message:this.activeResponse.state.message,messages:this.state.messages,isAbort:d,isDisconnect:u,isError:c})}catch(e){console.error(e)}this.activeResponse=void 0}(null==(l=this.sendAutomaticallyWhen)?void 0:l.call(this,{messages:this.state.messages}))&&await this.makeRequest({trigger:"submit-message",messageId:null==(n=this.lastMessage)?void 0:n.id,metadata:t,headers:a,body:s})}},et=i.Ry({type:i.i0("text"),text:i.Z_(),state:i.Km(["streaming","done"]).optional(),providerMetadata:h.optional()}),ea=i.Ry({type:i.i0("reasoning"),text:i.Z_(),state:i.Km(["streaming","done"]).optional(),providerMetadata:h.optional()}),es=i.Ry({type:i.i0("source-url"),sourceId:i.Z_(),url:i.Z_(),title:i.Z_().optional(),providerMetadata:h.optional()}),er=i.Ry({type:i.i0("source-document"),sourceId:i.Z_(),mediaType:i.Z_(),title:i.Z_(),filename:i.Z_().optional(),providerMetadata:h.optional()}),eo=i.Ry({type:i.i0("file"),mediaType:i.Z_(),filename:i.Z_().optional(),url:i.Z_(),providerMetadata:h.optional()}),ei=i.Ry({type:i.i0("step-start")}),el=i.Ry({type:i.Z_().startsWith("data-"),id:i.Z_().optional(),data:i._4()}),en=[i.Ry({type:i.i0("dynamic-tool"),toolName:i.Z_(),toolCallId:i.Z_(),state:i.i0("input-streaming"),input:i._4().optional(),output:i.Fi().optional(),errorText:i.Fi().optional()}),i.Ry({type:i.i0("dynamic-tool"),toolName:i.Z_(),toolCallId:i.Z_(),state:i.i0("input-available"),input:i._4(),output:i.Fi().optional(),errorText:i.Fi().optional(),callProviderMetadata:h.optional()}),i.Ry({type:i.i0("dynamic-tool"),toolName:i.Z_(),toolCallId:i.Z_(),state:i.i0("output-available"),input:i._4(),output:i._4(),errorText:i.Fi().optional(),callProviderMetadata:h.optional(),preliminary:i.O7().optional()}),i.Ry({type:i.i0("dynamic-tool"),toolName:i.Z_(),toolCallId:i.Z_(),state:i.i0("output-error"),input:i._4(),output:i.Fi().optional(),errorText:i.Z_(),callProviderMetadata:h.optional()})],ep=[i.Ry({type:i.Z_().startsWith("tool-"),toolCallId:i.Z_(),state:i.i0("input-streaming"),providerExecuted:i.O7().optional(),input:i._4().optional(),output:i.Fi().optional(),errorText:i.Fi().optional()}),i.Ry({type:i.Z_().startsWith("tool-"),toolCallId:i.Z_(),state:i.i0("input-available"),providerExecuted:i.O7().optional(),input:i._4(),output:i.Fi().optional(),errorText:i.Fi().optional(),callProviderMetadata:h.optional()}),i.Ry({type:i.Z_().startsWith("tool-"),toolCallId:i.Z_(),state:i.i0("output-available"),providerExecuted:i.O7().optional(),input:i._4(),output:i._4(),errorText:i.Fi().optional(),callProviderMetadata:h.optional(),preliminary:i.O7().optional()}),i.Ry({type:i.Z_().startsWith("tool-"),toolCallId:i.Z_(),state:i.i0("output-error"),providerExecuted:i.O7().optional(),input:i._4(),output:i.Fi().optional(),errorText:i.Z_(),callProviderMetadata:h.optional()})];i.Ry({id:i.Z_(),role:i.Km(["system","user","assistant"]),metadata:i._4().optional(),parts:i.IX(i.G0([et,ea,es,er,eo,ei,el,...en,...ep]))})}}]);